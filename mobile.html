<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mobile</title>
<script src="./data.js"></script>
<style>
  :root{
    --bg:#000;
    --text:#fff;
    --panel:rgba(255,255,255,.06);
    --active:rgba(255,255,255,.16);
    --peach:#f4a08b;
    --peach2:#ffb39e;
    --stroke:rgba(255,255,255,.12);
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh;
    display:grid; place-items:center;
    background:var(--bg); color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  .phone{ width:390px; max-width:96vw; padding:16px 14px 18px; background:#000; }

  .toprow{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    margin:2px 0 10px;
  }
  .iconbtn{
    width:42px;height:42px;
    border-radius:14px;
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.06);
    color:rgba(255,255,255,.92);
    font-size:26px;
    font-weight:900;
    line-height:1;
    cursor:pointer;
    transition: transform .06s ease, background .18s ease;
  }
  .iconbtn:active{transform:scale(.99)}
  .stealthClock{
    width:165px;
    height:112px;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .clockSvg{ width:165px; height:112px; display:block; }

  .top{
    padding:2px 2px 12px;
    display:flex; flex-direction:column; gap:6px;
  }
  .activity{
    font-size:18px; font-weight:900; letter-spacing:.2px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-height:24px;
  }
  .timer{
    font-variant-numeric: tabular-nums;
    font-size:34px; font-weight:900; letter-spacing:.5px; line-height:1.05;
  }

  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .btn{
    border:0; border-radius:22px;
    background:var(--panel); color:var(--text);
    padding:18px 16px; min-height:86px;
    text-align:left; font-size:18px; font-weight:900;
    cursor:pointer;
    transition: transform .06s ease, background .18s ease;
  }
  .btn:active{transform:scale(.99)}
  .btn.active{ background:var(--active); }

  .bottom{ margin-top:14px; }
  .pause{
    width:100%;
    border:0; border-radius:28px;
    background:var(--peach); color:#000;
    padding:18px 16px; min-height:64px;
    font-size:18px; font-weight:900;
    cursor:pointer;
    transition: transform .06s ease, background .18s ease;
  }
  .pause:active{transform:scale(.99)}
  .pause.active{ background:var(--peach2); }
</style>
</head>
<body>
  <div class="phone">

    <div class="toprow">
      <button class="iconbtn" id="cancelBtn" aria-label="Cancel / reset running timer">×</button>

      <div class="stealthClock" aria-hidden="true">
        <svg viewBox="0 0 200 120" class="clockSvg">
          <!-- Track arc: 120° sweep, subtle -->
          <path id="arcTrack"
                d="M 40 100 A 80 80 0 0 1 160 70"
                fill="none" stroke="rgba(255,255,255,.18)" stroke-width="10" stroke-linecap="round"/>
          <!-- Progress arc -->
          <path id="arcProg"
                d="M 40 100 A 80 80 0 0 1 160 70"
                fill="none" stroke="rgba(255,255,255,.78)" stroke-width="10" stroke-linecap="round"/>

          <!-- Soft minimal bars -->
          <g id="hands" transform="translate(100 92)">
            <rect id="hourHand" x="-3" y="-48" width="6" height="46" rx="3" fill="rgba(255,255,255,.55)"></rect>
            <rect id="minHand"  x="-2" y="-58" width="4" height="56" rx="2" fill="rgba(255,255,255,.85)"></rect>
          </g>
        </svg>
      </div>
    </div>

    <div class="top">
      <div class="activity" id="activity">—</div>
      <div class="timer" id="timer">00:00:00</div>
    </div>

    <div class="grid" id="grid"></div>

    <div class="bottom">
      <button class="pause" id="pause">Pause</button>
    </div>
  </div>

<script>
(() => {
  const BREAK_ID = "break";

  const grid = document.getElementById("grid");
  const activity = document.getElementById("activity");
  const timer = document.getElementById("timer");
  const pause = document.getElementById("pause");
  const cancelBtn = document.getElementById("cancelBtn");

  // ----- LocalStorage keys (mock-stage) -----
  // Running timer:
  // { taskId, startMs, date:'YYYY-MM-DD' }
  const RUN_KEY = "tt_running";
  // Logs:
  // [{ date:'YYYY-MM-DD', taskId, startMs, endMs, billable:true }]
  const LOG_KEY = "tt_logs";
  // Active selection for UI continuity
  const UI_KEY  = "tt_activeTask";

  const pad = n => String(n).padStart(2,"0");
  const todayKey = (d=new Date()) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const fmtHMS = (ms) => {
    const s = Math.max(0, Math.floor(ms/1000));
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  const getRunning = () => { try { return JSON.parse(localStorage.getItem(RUN_KEY) || "null"); } catch { return null; } };
  const setRunning = (v) => localStorage.setItem(RUN_KEY, JSON.stringify(v));
  const getLogs = () => { try { return JSON.parse(localStorage.getItem(LOG_KEY) || "[]"); } catch { return []; } };
  const setLogs = (v) => localStorage.setItem(LOG_KEY, JSON.stringify(v));

  // Choose 4 tasks for mobile view (highest rates first)
  const taskIds = TR.state.activities
    .filter(a => a.id !== "break")
    .slice()
    .sort((a,b)=> b.rate - a.rate)
    .slice(0,4)
    .map(a => a.id);

  // ----- Core behavior: switch task stops previous + starts new -----
  function stopRunningIfAny(nowMs){
    const running = getRunning();
    if(!running || !running.startMs) return;

    const logs = getLogs();
    logs.push({
      date: running.date || todayKey(),
      taskId: running.taskId,
      startMs: running.startMs,
      endMs: nowMs,
      billable: running.taskId !== BREAK_ID
    });
    setLogs(logs);
    setRunning(null);
  }

  function startTask(taskId){
    const now = Date.now();
    stopRunningIfAny(now);

    const run = { taskId, startMs: now, date: todayKey() };
    setRunning(run);
    localStorage.setItem(UI_KEY, taskId);

    paint();
    updateStealthClock();
  }

  function resetRunning(){
    // "Cancel" resets the ongoing timer WITHOUT creating a log
    setRunning(null);
    localStorage.removeItem(UI_KEY);
    paint();
    updateStealthClock();
  }

  // ----- UI paint -----
  function paint(){
    const running = getRunning();
    const activeId = running?.taskId || null;

    [...grid.querySelectorAll(".btn")].forEach(b => {
      b.classList.toggle("active", b.dataset.id === activeId);
    });
    pause.classList.toggle("active", activeId === BREAK_ID);

    const label = activeId === BREAK_ID
      ? "Pause"
      : (activeId ? TR.taskName(activeId) : "—");

    activity.textContent = label || "—";
  }

  function render(){
    grid.innerHTML = "";
    taskIds.forEach(id => {
      const btn = document.createElement("button");
      btn.className = "btn";
      btn.dataset.id = id;
      btn.textContent = TR.taskName(id);
      btn.addEventListener("click", () => startTask(id));
      grid.appendChild(btn);
    });

    pause.addEventListener("click", () => startTask(BREAK_ID));
    cancelBtn.addEventListener("click", resetRunning);

    paint();
    updateStealthClock();
  }

  // ----- Timer label -----
  setInterval(() => {
    const running = getRunning();
    timer.textContent = running?.startMs ? fmtHMS(Date.now() - running.startMs) : "00:00:00";
  }, 250);

  // ----- Stealth clock -----
  function updateStealthClock(){
    const arc = document.getElementById("arcProg");
    const hourHand = document.getElementById("hourHand");
    const minHand = document.getElementById("minHand");

    if(!arc || !hourHand || !minHand) return;

    const logs = getLogs();
    const running = getRunning();
    const d = todayKey();

    let billableMs = 0;

    for(const r of logs){
      if(r?.date === d && r?.billable !== false && r.startMs && r.endMs){
        billableMs += Math.max(0, r.endMs - r.startMs);
      }
    }

    if(running && running.date === d && running.startMs){
      const isBreak = running.taskId === BREAK_ID;
      if(!isBreak) billableMs += Math.max(0, Date.now() - running.startMs);
    }

    const billableHours = billableMs / 3600000;

    // Cap = 8 billed hours per day (feel free to change)
    const CAP = 8;
    const pct = Math.max(0, Math.min(1, billableHours / CAP));

    const len = arc.getTotalLength();
    arc.style.strokeDasharray = `${len}`;
    arc.style.strokeDashoffset = `${len * (1 - pct)}`;

    // Abstract hands across 120° sweep
    const sweep = 120;
    const hourAngle = (-60) + (pct * sweep);

    const mins = new Date().getMinutes() / 60;
    const minAngle = (-60) + (mins * sweep);

    hourHand.setAttribute("transform", `rotate(${hourAngle})`);
    minHand.setAttribute("transform", `rotate(${minAngle})`);
  }

  setInterval(updateStealthClock, 1000);

  render();
})();
</script>
</body>
</html>
